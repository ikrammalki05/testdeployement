name: Mobile CD (React Native Android)

on:
  push:
    branches: [ develop ]
    paths:
      - 'mobile/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment de dÃ©ploiement'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json
    
    - name: Install dependencies
      run: |
        cd mobile
        npm ci
    
    - name: Configure environment
      run: |
        cd mobile
        echo "API_URL=${{ secrets.API_URL }}" > .env
        echo "APP_ENV=${{ github.event.inputs.environment || 'staging' }}" >> .env
    
    - name: Make gradlew executable
      run: chmod +x mobile/android/gradlew
    
    - name: Build Android Release APK
      run: |
        cd mobile/android
        ./gradlew assembleRelease
      env:
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    
    - name: Sign APK
      run: |
        cd mobile/android/app/build/outputs/apk/release
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore ${{ secrets.ANDROID_KEYSTORE_BASE64 }} \
          -storepass ${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
          -keypass ${{ secrets.ANDROID_KEY_PASSWORD }} \
          app-release-unsigned.apk key0
      continue-on-error: true
    
    - name: Deploy to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: testers, beta-users
        file: mobile/android/app/build/outputs/apk/release/app-release.apk
        releaseNotes: |
          ğŸš€ Nouvelle version React Native dÃ©ployÃ©e
          ğŸ“ Commit: ${{ github.sha }}
          ğŸ‘¤ Par: ${{ github.actor }}
          ğŸ“… Date: ${{ github.event.head_commit.timestamp }}
          ğŸŒ Environnement: ${{ github.event.inputs.environment || 'staging' }}
    
    - name: Deploy to Google Play (Internal Testing)
      uses: r0adkll/upload-google-play@v1
      if: github.event.inputs.environment == 'production'
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.debatarena.mobile
        releaseFiles: mobile/android/app/build/outputs/apk/release/app-release.apk
        track: internal
        status: completed
      continue-on-error: true
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-apk-production-${{ github.sha }}
        path: mobile/android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90
    
    - name: Create GitHub Release
      if: github.event.inputs.environment == 'production'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: mobile-v${{ github.run_number }}
        name: Mobile Release v${{ github.run_number }}
        body: |
          ğŸš€ **DÃ©ploiement Mobile Android - Production**
          
          ğŸ“± **APK React Native:** Disponible en tÃ©lÃ©chargement
          
          **Commit:** ${{ github.sha }}
          **Auteur:** ${{ github.actor }}
          **Date:** ${{ github.event.head_commit.timestamp }}
        files: mobile/android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notification Slack (optional)
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ DÃ©ploiement Mobile React Native terminÃ©!
          ğŸ“± Android APK: ${{ job.status }}
          ğŸŒ Environnement: ${{ github.event.inputs.environment || 'staging' }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      continue-on-error: true
    
    - name: Deployment summary
      run: |
        echo "âœ… DÃ©ploiement React Native Android terminÃ©!"
        echo "ğŸ“± APK dÃ©ployÃ© sur Firebase App Distribution"
        echo "ğŸŒ Environnement: ${{ github.event.inputs.environment || 'staging' }}"
        echo "ğŸ’¾ APK disponible dans les artifacts"